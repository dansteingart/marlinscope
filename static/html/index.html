<html>
    <!-- to do: 
        [ ] - position memory?
        [x] - zscan controls
    
    -->
    <head>
        <script src="/static/js/jquery-3.6.0.min.js"></script>
        <script src="/static/js/js.cookie.min.js"></script>
        <script src="/static/js/gamecontroller.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            body{font-family: Helvetica,Arial, sans-serif;}
            img{width:100%}
            input{outline: none; border:none;border-bottom: 1px solid black;text-align: right;width:50px;}
            .status{height:20px;}
            textarea{outline: none; border: 1px solid black;text-align: left;width:50px;  resize:vertical;height:150px}
            .img{float:right;max-height:500px;width:60%;}
            .meta{width:200px;text-align:left}
            h2::selection{background: white;}
            .hider {visibility:hidden;}
            .shower {visibility:visible;}
            .terminal{
                background:black;
                color:green;
                white-space:pre-wrap;
                font-family: 'Courier New', Courier, monospace;

            }
            td{vertical-align: top;}

            /* Camera control styles */
            .v4l2-control-row {
                margin-bottom: 10px;
            }
            .v4l2-label {
                display: inline-block;
                width: 200px;
                cursor: help;
            }
            .v4l2-slider {
                width: 200px;
                vertical-align: middle;
                margin: 0 10px;
                -webkit-appearance: none;
                appearance: none;
                height: 4px;
                background: #000;
                outline: none;
            }
            .v4l2-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 8px;
                height: 16px;
                background: #000;
                cursor: pointer;
                border: none;
            }
            .v4l2-slider::-moz-range-thumb {
                width: 8px;
                height: 16px;
                background: #000;
                cursor: pointer;
                border: none;
            }
            .v4l2-slider:disabled {
                background: #ccc;
            }
            .v4l2-slider:disabled::-webkit-slider-thumb {
                background: #999;
            }
            .v4l2-slider:disabled::-moz-range-thumb {
                background: #999;
            }
            .v4l2-input {
                width: 60px;
                text-align: center;
            }
            .v4l2-info {
                font-size: 0.85em;
                color: #666;
                margin-left: 10px;
            }

            /* Tooltip styles */
            .tooltip {
                position: relative;
                display: inline-block;
            }
            .tooltip .tooltiptext {
                visibility: hidden;
                width: 300px;
                background-color: #333;
                color: #fff;
                text-align: left;
                border-radius: 6px;
                padding: 8px;
                position: absolute;
                z-index: 1;
                bottom: 125%;
                left: 50%;
                margin-left: -150px;
                opacity: 0;
                transition: opacity 0.3s;
                font-size: 0.9em;
                line-height: 1.4;
            }
            .tooltip .tooltiptext::after {
                content: "";
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 5px;
                border-style: solid;
                border-color: #333 transparent transparent transparent;
            }
            .tooltip:hover .tooltiptext {
                visibility: visible;
                opacity: 1;
            }

        </style>
    </head>
    <body>
        <div id="image" class="img"></div>
        <h1>MarlinScope</h1>
        <div id="status_shell" class="status"><span id="status"></span></div>
        <table id = "stage_std">
            <tr><td>move x/y</td><td><input id='movexy' value=0.2> </input>mm</td></tr>
            <tr><td>move z</td><td><input id='movez' value=0.02> </input>mm</td></tr>
            <tr><td>X</td><td><input id='posX' value=1 readonly> </input>mm</td><td><button attr='mvb' id='xb' title='â¬…ï¸'>x-</button><button attr='mvb' id='xf' title='âž¡ï¸'>x+</button></td></tr>
            <tr><td>Y</td><td><input id='posY' value=1 readonly> </input>mm</td><td><button attr='mvb' id='yb' title='â¬‡ï¸'>y-</button><button attr='mvb' id='yf' title='â¬†ï¸'>y+</button></td></tr>
            <tr><td>Z</td><td><input id='posZ' value=1 readonly> </input>mm</td><td><button attr='mvb' id='zb' title='s'>z-</button><button attr='mvb' id='zf' title='w'>z+</button></td></tr>
        </table>

        <h2 id="meta_head">Meta</h2>
        <div id="meta_table">
            <table>
                <tr><td>project</td><td><input   attr="meta" id='project' class="meta"> </input></td><td><button id="snapshot">ðŸ“¸</button></td></tr>
                <tr><td>prefix</td><td><input    attr="meta" id='prefix' class="meta" value="snap"> </input></td></tr>
                <tr><td>user</td><td><input      attr="meta" id='user' class="meta"> </input></td></tr>
                <tr><td>date/time</td><td><input             id='datetime' class="meta" readonly> </input></td></tr>
                <tr><td>notes</td><td><textarea  attr="meta" id='notes' class="meta"></textarea></td></tr>
                
            </table>
        </div>

        <h2 id='zscan_head'>Z Scan</h2>
        <table id='zscan_table'>
        <tr><td>Z endpoint (> current)</td><td><input id='z2'></input>mm</td><td><button id="do_zscan">go</button></td></tr>
        <tr><td id='zscanstatus'>done</td></tr>
        </table>

        <h2 id="v42l_head">Camera Controls</h2>
        <div id="v4l2_table"></div>

        <h2 id="abs_move_head">Absolute Positioning</h2>
        <div id="abs_move_table">
        <table>
            <tr><td>X</td><td><input id='absmoveX'> </input>mm</td><td><button id="absmove">go</button></td></tr>
            <tr><td>Y</td><td><input id='absmoveY'> </input>mm</td></tr>
            <tr><td>Z</td><td><input id='absmoveZ'> </input>mm</td></tr>
            <tr><td><button id="zero">zero</button></td><td><button id="home">âŒ‚</button></td></tr>
        </table>
        </div>


        <h2 id="exec_head">Spooky Scary</h2>
        <div id = "exec_list">
            <input id="exec_in" style="width:200px;text-align:left;"></input><button id="exec_send">Send</button>
            <div id="exec_out" class="terminal"></div>
        </div>

    
    <script>
            $.get("/get_camera_port",(data)=>{
            
            surl = `http://${window.location.hostname}:${window.location.port}`
            curl = `http://${window.location.hostname}:${data['camera_port']}`
            $("#image").html(`<img src="${curl}/.?action=stream">`)
  
            })

            $.get("/get_current_position",(data)=>{
                if (data['current_position']['status'] == "no stage") {
                    $("#stage_std").hide()
                    $("#zscan_head").hide()
                    $("#abs_move_head").hide()
                    $("#v4l2_table").toggle()

                }
                }
            )

            var socket = io();
            socket.on('data', (msg) => {find_position(msg)})
 
            poslog = ""
            function find_position(msg)
            {
                poslog += msg
                pat = /(?=X)(.*?)(?=Count)/g
                last_pos = [...poslog.matchAll(pat)]
                a = new Date();
                $("#datetime").val(a.toLocaleString());
                if (last_pos.length > 0)
                {
                    parse_position(last_pos[last_pos.length-1][0])
                    poslog="";
                }
            }
            
            function parse_position(str)
            {
                parts = str.trim().split(" ")
                obj = {}
                for (p in parts) obj[parts[p].split(":")[0]] = parts[p].split(":")[1]
                if ($("#posX").val() != obj['X']) $("#posX").val(obj['X']).trigger("change");
                if ($("#posY").val() != obj['Y']) $("#posY").val(obj['Y']).trigger("change");
                if ($("#posZ").val() != obj['Z']) $("#posZ").val(obj['Z']).trigger("change");
                return obj

            }

            // functions for v4l2 stuffs
            function arb_exec(cmd,channel='exec'){$.post(`/exec`,data={'payload':cmd,'channel':channel})};
            function arb_proc(cmd,channel='exec'){$.post(`/proc`,data={'payload':cmd,'channel':channel})};

            v4l2_ctl = undefined
            kk = undefined

            // Refresh v4l2 controls without toggling visibility
            function refresh_v4l2_controls(){
                $.post(`/v4l2-ctl-list`,
                        (data)=>{
                            console.log("Refreshing v4l2 controls...")
                            v4l2_ctl = parse_v4l2_controls(data['stdout']);
                            v4l2_tab = make_v4l2_table(v4l2_ctl);
                            $("#v4l2_table").html(v4l2_tab);
                            // Don't toggle - keep it visible

                            // Re-attach event handlers
                            attach_v4l2_handlers();
                        }
                    );
            }

            function attach_v4l2_handlers(){
                // Handle checkbox controls
                $('input[type=checkbox][attr=v4l2_cntl]').change((ev)=>
                {
                   value = ev.target.checked ? '1' : '0';
                   cmd = `v4l2-ctl -d /dev/video0 -c ${ev.target.id.replace("#","")}=${value}`
                   arb_exec(cmd)

                   // Refresh controls after a short delay to update dependencies
                   setTimeout(() => { refresh_v4l2_controls(); }, 200);
                })

                // Handle slider controls - sync with number input
                $('input[attr=v4l2_slider]').on('input', (ev)=>
                {
                   // ev.target.id is the actual DOM id, which includes the # in the string
                   // e.g., the id attribute is id='#brightness_slider', so ev.target.id = '#brightness_slider'
                   sliderId = ev.target.id; // e.g., "#brightness_slider"
                   controlId = sliderId.replace("_slider", ""); // e.g., "#brightness"

                   console.log("Slider:", sliderId, "-> Control:", controlId, "Value:", ev.target.value);

                   // The jQuery selector needs the id WITH the # already in it
                   // Since controlId is already "#brightness", use it directly
                   $('[id="' + controlId + '"]').val(ev.target.value);

                   // Send command (strip the # for the command)
                   cmd = `v4l2-ctl -d /dev/video0 -c ${controlId.replace("#","")}=${ev.target.value}`
                   arb_exec(cmd)
                })

                // Handle number input controls (non-checkbox)
                $('input[type=number][attr=v4l2_cntl]').on('input change', (ev)=>
                {
                   // ev.target.id includes the # in the string, e.g., "#brightness"
                   controlId = ev.target.id;
                   sliderId = controlId + "_slider"; // e.g., "#brightness_slider"

                   console.log("Control:", controlId, "-> Slider:", sliderId, "Value:", ev.target.value);

                   // Update corresponding slider if it exists
                   sliderEl = $('[id="' + sliderId + '"]');
                   if (sliderEl.length) {
                       sliderEl.val(ev.target.value);
                   }

                   // Send command (strip the # for the command)
                   cmd = `v4l2-ctl -d /dev/video0 -c ${controlId.replace("#","")}=${ev.target.value}`
                   arb_exec(cmd)

                   // Check if this is a control that might affect others (like auto_exposure, white_balance_automatic)
                   controlName = controlId.replace("#", "");
                   if (controlName.includes("auto") || controlName.includes("exposure") || controlName.includes("white_balance")) {
                       // Refresh controls after a short delay to update dependencies
                       setTimeout(() => { refresh_v4l2_controls(); }, 200);
                   }
                })

                // Handle select/dropdown controls (menu types)
                $('select[attr=v4l2_cntl]').change((ev)=>
                {
                   cmd = `v4l2-ctl -d /dev/video0 -c ${ev.target.id.replace("#","")}=${ev.target.value}`
                   arb_exec(cmd)

                   // Refresh controls after a short delay to update dependencies
                   setTimeout(() => { refresh_v4l2_controls(); }, 200);
                })

                // Handle regular input controls (fallback)
                $('input[attr=v4l2_cntl]:not([type=checkbox]):not([type=number])').change((ev)=>
                {
                   cmd = `v4l2-ctl -d /dev/video0 -c ${ev.target.id.replace("#","")}=${ev.target.value}`
                   arb_exec(cmd)
                })
            }

            function get_v4l2_ctl(){
                $.post(`/v4l2-ctl-list`,
                        (data)=>{
                            console.log(data)
                            v4l2_ctl = parse_v4l2_controls(data['stdout']);
                            v4l2_tab = make_v4l2_table(v4l2_ctl);
                            $("#v4l2_table").html(v4l2_tab);
                            $("#v4l2_table").toggle();

                            // Attach event handlers
                            attach_v4l2_handlers();
                            }
                        )
                    };

            function get_camera_state()
            {
                cam_out = {}
                cams = $('input[attr=v4l2_cntl]')
                for (i = 0; i < cams.length;i++) 
                {
                 cam_out[cams[i].id.replace("#","")] = cams[i].value
                }
                return cam_out
            }

            function get_meta()
            {
                meta = {}
                metas = $('[attr=meta]')
                for (i = 0; i < metas.length;i++) 
                {
                    meta[metas[i].id.replace("#","")] = metas[i].value
                }
                return meta
            }

            function set_meta()
            {
                try
                {
                    meta = JSON.parse(Cookies.get("meta"))
                    for (i in meta) $(`#${i}`).val(meta[i])
                }
                catch (error) {console.log(error)}
                

            }

            function parse_v4l2_controls(str)
            {
                cntls = str.trim().split("\n")
                obj = {}
                currentControl = null

                for (c in cntls)
                {
                    line = cntls[c].trim()

                    // Check if this is a menu option line (starts with number and colon)
                    if (line.match(/^\d+:/)) {
                        if (currentControl && obj[currentControl]) {
                            // This is a menu option
                            if (!obj[currentControl]['menu_options']) {
                                obj[currentControl]['menu_options'] = []
                            }
                            // Parse menu option: "1: Manual Mode"
                            optMatch = line.match(/^(\d+):\s*(.+)/)
                            if (optMatch) {
                                obj[currentControl]['menu_options'].push({
                                    value: optMatch[1],
                                    label: optMatch[2]
                                })
                            }
                        }
                    }
                    else if (line.search(":") > -1)
                    {
                        // This is a control definition line
                        cntl = line.split(":")
                        name = cntl[0].split(" ")[0]
                        currentControl = name
                        obj[name] = {}
                        obj[name]['hex']  = cntl[0].split(" ")[1]
                        obj[name]['type'] = cntl[0].split(" ")[2]

                        // Parse the right side of the colon for metadata
                        rightSide = cntl[1].trim()
                        parts = rightSide.split(" ")

                        for (a in parts)
                        {
                            if (parts[a].indexOf("=") > -1) {
                                aa = parts[a].split("=");
                                obj[name][aa[0]] = aa[1]
                            }
                        }

                        // Extract menu options if present (text in parentheses)
                        menuMatch = rightSide.match(/\(([^)]+)\)/)
                        if (menuMatch) {
                            obj[name]['menu_text'] = menuMatch[1]
                        }

                        // Check for flags
                        if (rightSide.indexOf("flags=") > -1) {
                            flagMatch = rightSide.match(/flags=([^\s]+)/)
                            if (flagMatch) {
                                obj[name]['flags'] = flagMatch[1]
                            }
                        }
                    }
                }
                return obj
            }

            function make_v4l2_table(obj){
                out = "<div style='visibility:inherit;'>"
                for (key in obj)
                {
                    ctrl = obj[key]

                    // Build tooltip text
                    tooltipText = `Type: ${ctrl['type']}<br>`;
                    if (ctrl['min'] !== undefined) tooltipText += `Range: ${ctrl['min']} to ${ctrl['max']}<br>`;
                    if (ctrl['step'] !== undefined) tooltipText += `Step: ${ctrl['step']}<br>`;
                    if (ctrl['default'] !== undefined) tooltipText += `Default: ${ctrl['default']}<br>`;
                    if (ctrl['flags'] !== undefined) tooltipText += `Flags: ${ctrl['flags']}<br>`;
                    if (ctrl['menu_text'] !== undefined) tooltipText += `Current: ${ctrl['menu_text']}<br>`;
                    tooltipText += `Hex: ${ctrl['hex']}`;

                    out += `<div class='v4l2-control-row'>`;

                    // Label with tooltip
                    out += `<span class='v4l2-label tooltip'>${key}`;
                    out += `<span class='tooltiptext'>${tooltipText}</span>`;
                    out += `</span>`;

                    // Determine control type and render appropriately
                    if (ctrl['type'] === '(bool)') {
                        // Boolean toggle
                        checked = (ctrl['value'] == '1') ? 'checked' : '';
                        out += `<input type='checkbox' attr='v4l2_cntl' id='#${key}' ${checked} value='${ctrl['value']}'>`;
                    } else if (ctrl['type'] === '(int)' && ctrl['min'] !== undefined && ctrl['max'] !== undefined) {
                        // Integer with slider
                        min = parseInt(ctrl['min'])
                        max = parseInt(ctrl['max'])
                        step = ctrl['step'] !== undefined ? parseInt(ctrl['step']) : 1
                        value = parseInt(ctrl['value'])

                        // Check if inactive
                        disabled = (ctrl['flags'] === 'inactive') ? 'disabled' : '';

                        out += `<input type='range' class='v4l2-slider' attr='v4l2_slider' id='#${key}_slider' `;
                        out += `min='${min}' max='${max}' step='${step}' value='${value}' ${disabled}>`;
                        out += `<input type='number' class='v4l2-input' attr='v4l2_cntl' id='#${key}' `;
                        out += `min='${min}' max='${max}' step='${step}' value='${value}' ${disabled}>`;

                        if (disabled) {
                            out += `<span class='v4l2-info'>(inactive)</span>`;
                        }
                    } else if (ctrl['type'] === '(menu)') {
                        // Menu type - show as dropdown select if menu_options available
                        if (ctrl['menu_options'] && ctrl['menu_options'].length > 0) {
                            out += `<select class='v4l2-input' attr='v4l2_cntl' id='#${key}' style='width:auto;'>`;
                            for (let i = 0; i < ctrl['menu_options'].length; i++) {
                                opt = ctrl['menu_options'][i];
                                selected = (opt.value == ctrl['value']) ? 'selected' : '';
                                out += `<option value='${opt.value}' ${selected}>${opt.value}: ${opt.label}</option>`;
                            }
                            out += `</select>`;
                        } else {
                            // Fallback to number input if no menu options
                            out += `<input type='number' class='v4l2-input' attr='v4l2_cntl' id='#${key}' value='${ctrl['value']}'>`;
                            if (ctrl['menu_text'] !== undefined) {
                                out += `<span class='v4l2-info'>${ctrl['menu_text']}</span>`;
                            }
                        }
                    } else {
                        // Default to regular input
                        out += `<input class='v4l2-input' attr='v4l2_cntl' id='#${key}' value='${ctrl['value']}'>`;
                    }

                    out += `</div>`;
                }
                out+="</div>"
                return out

            }

            $("#v42l_head").click(()=>{$("#v4l2_table").toggle()})
            $("#zscan_head").click(()=>{$("#zscan_table").toggle()})            
            $("#exec_head").click(()=>{$("#exec_list").toggle()})
            $("#abs_move_head").click(()=>{$("#abs_move_table").toggle()})

            $("#absmove").click(() =>
                {
                    x = parseFloat($("#absmoveX").val())
                    y = parseFloat($("#absmoveY").val())
                    z = parseFloat($("#absmoveZ").val())
                    absmove(x,y,z)
                }
            )

            $("#zero").click(()=>{$.post(`/write`,data={'payload':`G92 X0 Y0 Z0\n`})})
            $("#home").click(()=>{home();})

            //Let's execute arbirary code!
            $("#exec_send").click(()=>{arb_exec($("#exec_in").val())})
            socket.on('exec',(msg) =>{$("#exec_out").html(msg)});
            socket.on('zscan',(msg) =>{
                $("#zscanstatus").html(msg)
                if (msg.search("done")>-1) $("#do_zscan").attr("disabled",false);
            });

            //auto zscan
            function zscan()
            {
                $("#zscanstatus").html("starting...")
                $("#do_zscan").attr("disabled",true)
                z2 = $("#z2").val();
                z1 = $("#posZ").val();
                project = $("#project").val();
                prefix  = $("#prefix").val(); 
                user  = $("#prefix").val(); 
                cmd = `python3 -u /home/pi/pithy/code/enderscope_z_scan.py prefix=${prefix} project=${project} user=${user} z1=${z1} z2=${z2}`
                arb_proc(cmd,channel="zscan");
            }

            $("#do_zscan").click(zscan);

            //stage control
            function move(x,y,z)
            {
                out = `G91\nG0 F2000 X${x} Y${y} Z${z}`
                $.post(`/write`,data={'payload':`${out}\n`})
            }

            function absmove(x,y,z)
            {
                out = `G90\nG0 F2000 X${x} Y${y} Z${z}`
                $.post(`/write`,data={'payload':`${out}\n`})
            }

            function get_position(){$.post(`/write`,data={'payload':'M114\n'})}
            
            function steppers_off(){$.get(`/writecf/M18 X Y Z`)}

            function home(){$.post(`/write`,data={'payload':'G28\n'})}    
        
            function snapshot()
            {
                tt = new Date()
                data = {}
                data['project'] =$("#project").val()
                data['prefix'] = $("#prefix").val()
                data['user']   = $("#user").val()
                data['position'] = {'x':$("#posX").val(),'y':$("#posY").val(),'z':$("#posZ").val()}
                data['notes'] = $("#notes").val()
                data['camera'] = get_camera_state();
                data['date'] = tt.getTime();
                console.log(data)
                $.post("/snapshot",data,(res)=>{
                    console.log(res);
                    $("#status").html(`saved ${$("#project").val()}/${$("#prefix").val()}`)
                    $("#status").fadeIn()
                    $("#status").fadeOut("slow",()=>{$("#status").html("")})
; 
                })
            }


            $(window).keydown((e)=>{
                zz = parseFloat($("#movez").val())
                xy = parseFloat($("#movexy").val())
                if ($("input").is(":focus") == false & $("textarea").is(":focus") == false)
                {
                    var fac = 1;
                    if (e.shiftKey) fac = 10;
                    switch(e.originalEvent.keyCode)
                    {
                        
                        case 37: move(-fac*xy,0,0); break;
                        case 39: move(fac*xy,0,0);break;
                        case 38: move(0,fac*xy,0);break;
                        case 40: move(0,-fac*xy,0);break;
                        case 87: move(0,0,fac*zz);break;
                        case 83: move(0,0,-fac*zz);break;
                        case 77: get_position();break;
                        case 79: steppers_off();break;
                        case 67: snapshot();break;
                    }
                }

            })

            //buttons for the olds, or youngs I guess
            $("#xf").click((e)=>{xy = parseFloat($("#movexy").val());move( xy,0,0)})
            $("#xb").click((e)=>{xy = parseFloat($("#movexy").val());move(-xy,0,0)})
            $("#yf").click((e)=>{xy = parseFloat($("#movexy").val());move(0, xy,0)})
            $("#yb").click((e)=>{xy = parseFloat($("#movexy").val());move(0,-xy,0)})
            $("#zf").click((e)=>{xy = parseFloat($("#movezz").val());move(0,0, zz)})
            $("#zb").click((e)=>{xy = parseFloat($("#movezz").val());move(0,0,-zz)})
            $("#snapshot").click((e)=>{snapshot();})

            //gamepad!
            keymap = [['up',"U"],['down',"D"],['left',"L"],['right',"R"],['button0',"X"],['button1',"A"],['button2',"B"],['button3',"Y"],['button4',"TL"],['button5',"TR"],['button8',"select"],['button9',"start"]]
            jog = false;
            gameControl.on('connect',(gp)=>{for (let i = 0; i < keymap.length;i++) 
                {
                    gp.before(keymap[i][0],()=>{
                        switch(keymap[i][1])
                        {
                            case "Y": jog=true; break;
                            case "U": case "D": case "L": case "R": case "TR": case "TL": case "A": game_move(keymap[i][1]);
                        }
                    })
                    .on(keymap[i][0],()=>{
                        switch(keymap[i][1])
                        {
                            case "U": case "D": case "L": case "R": case "TR": case "TL": if(jog)game_move(keymap[i][1]);break;
                        }
                    })
                    .after(keymap[i][0],()=>{
                        switch(keymap[i][1])
                        {
                            case "Y": jog=false;break;
                        }})
                }})
            function game_move(dir)
            {
                zz = parseFloat($("#movez").val())
                xy = parseFloat($("#movexy").val())
                switch(dir)
                {
                    case "L": move(-1*xy,0,0); break;
                    case "R": move(1*xy,0,0);break;
                    case "U": move(0,1*xy,0);break;
                    case "D": move(0,-1*xy,0);break;
                    case "TR": move(0,0,zz);break;
                    case "TL": move(0,0,-1*zz);break;
                    case "A" : snapshot(); break;
                    // case 77: get_position();break;
                    // case 79: steppers_off();break;
                    // case 67: snapshot();break;

                }

            }


            //on load

            //fill meta from cookie
            set_meta()

            //reset camera
            arb_exec(`
            v4l2-ctl -d /dev/video0 -c exposure_auto=1;
            v4l2-ctl -c white_balance_temperature_auto=1;
            v4l2-ctl -c gamma=100`)
            //get controls
            get_v4l2_ctl();
            $("#zscan_table").toggle();
            $("#abs_move_table").toggle();
            //hide spooky scary
            $("#exec_head").toggle()
            $("#exec_list").toggle()


            //register listeners
            $('input[attr=meta]').change(()=>{Cookies.set("meta",JSON.stringify(get_meta()))});
            $("#posX").change((ev)=>{$("#absmoveX").val($("#posX").val())})
            $("#posY").change((ev)=>{$("#absmoveY").val($("#posY").val())})
            $("#posZ").change((ev)=>{$("#absmoveZ").val($("#posZ").val())})


            //stop the scroll 
            window.addEventListener("keydown", function(e) {
            if(["ArrowUp","ArrowDown"].indexOf(e.code) > -1) 
            {e.preventDefault();}
            }, false);


        </script>

    </body>

</html>
